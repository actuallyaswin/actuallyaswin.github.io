# Music Browser - Development Context

## Project Overview

A lightweight, static web application for browsing Last.fm listening history. Runs entirely in the browser using SQLite WASM (sql.js). Hosted on GitHub Pages.

**Live URL**: `https://actuallyaswin.github.io/music/`
**Local Test**: `http://127.0.0.1:8080/music/`

## Project Structure

```
/Users/aswin/github/actuallyaswin.github.io/music/
â”œâ”€â”€ index.html                   # Homepage with top artists/albums
â”œâ”€â”€ year.html                    # Year-specific view (2011-2025)
â”œâ”€â”€ artist.html                  # Artist detail page
â”œâ”€â”€ release.html                 # Release/album detail page
â”œâ”€â”€ config.js                    # Database configuration (version, URL)
â”œâ”€â”€ app.js                       # Homepage logic (7 KB)
â”œâ”€â”€ year.js                      # Year page logic (10 KB)
â”œâ”€â”€ artist.js                    # Artist page logic (11 KB)
â”œâ”€â”€ release.js                   # Release page logic (10 KB)
â”œâ”€â”€ theme.js                     # Theme management (2 KB)
â”œâ”€â”€ styles.css                   # Global styles with themes (13 KB)
â”œâ”€â”€ logo.svg                     # Site logo (kept but not used)
â””â”€â”€ README.md                    # Documentation

Database: Hosted on GitHub Releases (not in repo)
â””â”€â”€ listening_history.sqlite     # SQLite database (56 MB)
```

**Total**: ~2,450 lines of code across 11 files

**Note**: Logo is now plain text (`aswin.db/music`) styled with CSS instead of SVG

## Database Hosting

**Strategy**: GitHub Releases + CDN (not stored in repo)

- **Location**: GitHub Releases at `music-db-v{version}` tags
- **Access**: Direct URL via GitHub or jsDelivr CDN
- **Size**: 56 MB (too large for git repo)
- **Configuration**: Centralized in `config.js`

### config.js Structure
```javascript
const DB_CONFIG = {
    version: 'v1.0',      // Update this for new releases
    repo: 'actuallyaswin/actuallyaswin.github.io',
    filename: 'listening_history.sqlite',

    localPath: 'listening_history.sqlite',  // For local development
    cdnUrl: 'https://github.com/.../music-db-v1.0/...',  // For production

    // Smart fetch: tries local first, falls back to CDN
    async fetchDatabase() { ... }
};
```

**Behavior:**
- **Local development**: Tries `listening_history.sqlite` in `/music/` folder
- **Production/CDN**: Falls back to GitHub Releases if local not found
- **Console logs**: Shows which source was used ("local file" or "CDN")

### Updating Database
1. Create new tag: `git tag -a music-db-v1.1`
2. Push tag: `git push origin music-db-v1.1`
3. Create GitHub Release with new database file
4. Update `config.js`: Change `version: 'v1.1'`
5. Commit and deploy

## Technology Stack

- **Frontend**: Vanilla JavaScript (ES6+)
- **Database**: SQLite WASM via sql.js 1.8.0
- **Charts**: Chart.js 4.4.1
- **Styling**: Pure CSS with CSS Grid/Flexbox
- **CDN**: Cloudflare (sql.js), jsDelivr (Chart.js)
- **Hosting**: GitHub Pages (free, HTTPS, CDN)

**No build tools required** - Everything runs directly in browser

## Database Schema

Generated by `/Users/aswin/github/lfm-to-parquet/lastfm_importer.py`

### Tables (5 total)

1. **artists** (8,480 rows)
   - `artist_mbid` (PK), `artist_name`, `profile_image_url`, `banner_image_url`
   - Indexed on: `artist_mbid`, `artist_name`
   - **Images**: High-quality square artist photos (640x640) from Spotify API
   - Fallback to Last.fm images if Spotify unavailable

2. **releases** (14,556 rows)
   - `release_mbid` (PK), `release_name`, `release_date`, `release_year`
   - `release_type_primary` (album, single, ep, broadcast)
   - `release_type_secondary` (compilation, soundtrack, live, etc.)
   - `album_art_url`
   - Indexed on: `release_mbid`, `release_year`
   - **Images**: High-quality square album artwork (640x640) from Spotify API
   - Fallback to Last.fm images if Spotify unavailable

3. **tracks** (42,153 rows)
   - `track_mbid` (PK), `track_name`, `track_name_raw`, `track_url`
   - `duration_ms`, `release_mbid` (FK)
   - Indexed on: `track_mbid`, `release_mbid`, `track_name`

4. **track_artists** (45,548 rows - junction table)
   - `track_mbid` (FK), `artist_mbid` (FK), `artist_name`
   - `role` (main, featured, collaboration, remixer), `position`
   - Indexed on: `track_mbid`, `artist_mbid`, `role`

5. **listens** (124,483 rows - fact table)
   - `track_mbid` (FK), `timestamp` (Unix epoch)
   - `year`, `month`, `day`, `hour`, `day_of_week`
   - `main_artist_mbid`, `main_artist_name` (denormalized)
   - `album_mbid`, `album_name` (denormalized)
   - Indexed on: `track_mbid`, `timestamp`, `year`, `main_artist_mbid`, `album_mbid`

**Data Span**: 2011-2025 (14 years)

## Features

### Homepage (index.html)

1. **Database Statistics**
   - Total listens, artists, releases, tracks
   - Grid layout (4 cards)

2. **Artist Search**
   - Real-time autocomplete
   - Searches by artist name
   - Shows top 10 results with play counts
   - Closes on outside click

3. **Top Artists & Top Albums** (side-by-side on desktop, sortable, multiple views)
   - Layout: Two-column grid on desktop (â‰¥769px), single column on mobile
   - ğŸ§ Sort by play count (default)
   - â±ï¸ Sort by listening time
   - ğŸ“… Sort by release date (albums only, newest first)

   **View System** (2 independent toggles):
   - **Mode Toggle (ğŸ“‹ List button)**: Grid vs List layout
     - Grid: Square artwork cards
     - List: Text-only rows
   - **Stats Toggle (ğŸ‘ï¸ Eye button)**: Show/hide statistics
     - Stats ON: Shows overlay (grid) or metadata + icons (list)
     - Stats OFF: Pure artwork (grid) or names only (list)

   **4 Possible View Combinations:**
   1. **Grid + Stats** (default): Artwork with overlay (name + headphones/clock icons)
   2. **Grid without stats**: Pure artwork collage (no text/overlay)
   3. **List + Stats**: Text rows with name, metadata, and stat icons on right
   4. **List without stats**: Simple list of names only (minimal, scannable)

   **Controls Layout:**
   ```
   [ğŸ§] [â±ï¸] [ğŸ“…] | [ğŸ‘ï¸] [ğŸ“‹]
    Sort buttons   Separator  View toggles
   ```
   - **ğŸ‘ï¸ (Eye)**: Toggles stats on/off (works in both grid and list modes)
   - **ğŸ“‹ (List)**: Switches between grid and list layout
   - Both buttons show clear active states (primary color background)

### Artist Page (artist.html)

**Layout:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Photo] Artist Name              â”‚
â”‚    â™ª    5,234 plays Â· 145 tracks â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Listening History Over Time
[Monthly][Yearly] [Distribution][Cumulative]
[Chart - 300px height]

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Top Releases   â”‚ Top Tracks     â”‚
â”‚ ğŸ§ â±ï¸ ğŸ“…       â”‚ ğŸ§ â±ï¸          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Features:**
1. Artist photo placeholder (150x150px, musical note icon)
2. Compact stats (plays, tracks, releases)
3. Interactive chart with 4 modes:
   - Monthly/Yearly granularity
   - Distribution (bar) / Cumulative (line)
4. Top 20 tracks (sortable by listens/minutes)
5. Top 15 releases (sortable by listens/minutes/date)

**Mobile**: Stacks vertically (photo â†’ stats â†’ chart â†’ releases â†’ tracks)

### Release Page (release.html)

**Layout:**
```
Release Name
Artist Name Â· 2024 Â· album

[Stats: Total Plays | Tracks Listened]

Listening History Over Time
[Monthly][Yearly] [Distribution][Cumulative]
[Chart - 300px height]

Tracks
[Track list with play counts]
```

**Features:**
1. Release metadata (name, year, type)
2. Linked artist name
3. Interactive chart (same as artist page)
4. Complete track listing with:
   - Track name
   - All artists (main, featured, collaborations)
   - Play count (or "Not played")

### Year Page (year.html)

**Layout:**
```
â† [Year Selector Dropdown] â†’
Summary: N artists Â· M albums Â· X plays

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Top Artists    â”‚ Top Albums     â”‚
â”‚ ğŸ§ â±ï¸ | ğŸ‘ï¸ ğŸ“‹ â”‚ ğŸ§ â±ï¸ | ğŸ” ğŸ‘ï¸ ğŸ“‹â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Features:**
1. **Year Navigation**
   - Dropdown selector (2011-2025)
   - Left/right arrow buttons for previous/next year
   - URL parameter support (e.g., `year.html?year=2015`)
   - Automatically determines min/max years from database

2. **Year Summary Stats**
   - Artists discovered/listened in that year
   - Albums played in that year
   - Total plays for that year

3. **Top Artists** (same view system as homepage)
   - Layout: Side-by-side with albums on desktop (â‰¥769px)
   - ğŸ§ Sort by play count (default)
   - â±ï¸ Sort by listening time
   - **View System** (2 independent toggles):
     - **ğŸ‘ï¸ Eye button**: Toggle stats overlay
     - **ğŸ“‹ List button**: Toggle grid/list layout
   - Shows artists listened to during that year
   - Displays headphone (listens) and clock (minutes) icons
   - All 4 view combinations available (grid/list Ã— stats on/off)

4. **Top Albums** (same view system + filter)
   - ğŸ§ Sort by play count (default)
   - â±ï¸ Sort by listening time
   - **ğŸ” Filter button**: Toggle album filtering mode
     - **Filter OFF** (default): Albums listened to in that year (listens from that year)
     - **Filter ON** (active): Albums **released** in that year (all-time listens)
   - **View System** (2 independent toggles):
     - **ğŸ‘ï¸ Eye button**: Toggle stats overlay
     - **ğŸ“‹ List button**: Toggle grid/list layout
   - Displays headphone (listens) and clock (minutes) icons
   - Shows artist name, release year, and album type in overlay/list

**Controls Layout (Albums):**
```
[ğŸ§] [â±ï¸] | [ğŸ”] [ğŸ‘ï¸] [ğŸ“‹]
 Sort      Filter View toggles
```

**Filter Behavior:**
- **Default mode**: `l.year = 2015` - Shows albums you listened to in 2015
- **Filter active**: `r.release_year = 2015` - Shows albums released in 2015 (with all-time listen counts)
- Filter button shows active state (primary color background) when ON
- Useful for discovering albums released in a specific year

**Mobile**: Stacks vertically (year nav â†’ summary â†’ artists â†’ albums)

## Chart System

### Granularity Options
- **Monthly**: Shows listening by month (e.g., "Jan 2024")
- **Yearly**: Shows listening by year (e.g., "2024")

### Chart Types
- **Distribution**: Bar chart showing plays per period (histogram)
- **Cumulative**: Line chart showing running total over time (cumulative distribution)

### Smart Features
- **Label thinning**: Shows ~15 evenly spaced labels
  - Algorithm: `skipFactor = ceil(totalLabels / 15)`
  - Prevents label overlap on long date ranges
- **Fixed height**: 300px maximum (lean design)
- **Dynamic colors**: Reads from CSS variables
- **Theme-aware**: Updates when theme changes
- **Responsive**: Maintains readability on mobile

### Chart Configuration
```javascript
chartState = {
    granularity: 'monthly',    // or 'yearly'
    type: 'distribution'       // or 'cumulative'
}
```

## Sorting System

### Homepage
- **Top Artists**: listens, minutes
- **Top Albums**: listens, minutes, date

### Year Page
- **Top Artists**: listens, minutes
- **Top Albums**: listens, minutes

### Artist Page
- **Top Tracks**: listens, minutes
- **Top Releases**: listens, minutes, date

### Sort State Management
```javascript
sortState = {
    artists: 'listens',
    albums: 'listens'
}
```

### View State Management
```javascript
viewState = {
    artists: { mode: 'grid', showStats: true },  // mode: 'grid' or 'list', showStats: boolean
    albums: { mode: 'grid', showStats: true }
}
```

**View Properties:**
- `mode`: Layout mode - 'grid' (artwork cards) or 'list' (text rows)
- `showStats`: Whether to display statistics/metadata - true or false

**4 View Combinations:**
| Mode | Stats | Result |
|------|-------|--------|
| grid | true  | Artwork grid with overlay (name + icons) |
| grid | false | Pure artwork collage (no overlay) |
| list | true  | Text rows with metadata + stat icons |
| list | false | Text rows with names only |

**Toggle Behavior:**
- **Eye button (ğŸ‘ï¸)**: Toggles `showStats` property
  - Works independently in both grid and list modes
  - Active when `showStats = true` (shows primary color background)
- **List button (ğŸ“‹)**: Toggles `mode` property
  - Switches between 'grid' â†” 'list'
  - Active when `mode = 'list'` (shows primary color background)

**Active State Styling:**
- Buttons show `.active` class when their state is true
- Active style: primary color background, white text, primary border
- Inactive style: secondary background, tertiary text, border

### Duration Calculations

**Tracks:**
```sql
CAST(COUNT(l.timestamp) * COALESCE(t.duration_ms, 0) / 60000.0 AS INTEGER) as total_minutes
```
- Play count Ã— track duration
- Converts milliseconds to minutes

**Albums:**
```sql
CAST(SUM(COALESCE(t.duration_ms, 0)) / 60000.0 AS INTEGER) as total_minutes
```
- Sum of all track durations across all plays
- Accounts for multiple listens via JOIN

### Smart Display Logic
Stats text adapts to active sort:
- **Listens mode**: "1,234 plays Â· 567 min"
- **Minutes mode**: "567 min Â· 1,234 plays"
- **Date mode**: "2024 Â· 1,234 plays"

## Theme System

### Color Palette (CSS Variables)

**Dark Mode (Default):**
```css
--primary: #6366f1        /* Indigo */
--accent: #ec4899         /* Pink */
--bg: #0f172a            /* Dark slate */
--bg-secondary: #1e293b  /* Slate 800 */
--text: #f1f5f9          /* Light slate */
--text-secondary: #94a3b8 /* Slate 400 */
--border: #334155         /* Slate 700 */
```

**Light Mode:**
```css
--primary: #4f46e5        /* Darker indigo */
--accent: #db2777         /* Deep pink */
--bg: #fafbfc            /* Soft off-white */
--bg-secondary: #f1f3f5  /* Light gray */
--text: #0f172a          /* Dark slate */
--text-secondary: #475569 /* Slate 600 */
--border: #e2e8f0         /* Slate 200 */
```

**Chart Colors:**
```css
--chart-bg: rgba(...)        /* Transparent fill */
--chart-bg-solid: rgba(...)  /* Opaque bars */
```

### Theme Management (theme.js)

**Features:**
- Detects system preference via `prefers-color-scheme`
- Stores user preference in `localStorage`
- Auto-switches if system preference changes
- Persists across page navigations
- Provides `getCSSColor()` utility for JavaScript

**Toggle Button:**
- Fixed position (bottom-right)
- 56px circular button
- Icon changes: â˜€ï¸ (dark) / ğŸŒ™ (light)
- Hover/active states
- Accessible (aria-label)

**Implementation:**
```javascript
:root[data-theme="light"] { ... }  // Light mode activated
:root { ... }                       // Dark mode (default)
```

### Theme-Aware Charts

Charts automatically update colors when theme changes:
- MutationObserver watches `data-theme` attribute
- Reads colors from CSS variables dynamically
- Re-renders chart with new colors
- No hardcoded colors in JavaScript

### Logo System

**Plain Text Logo** (replaced SVG):
- Text: `aswin.db/music`
- Font: `ui-monospace, 'Cascadia Code', 'Source Code Pro', monospace`
- Theme-aware colors using CSS variables

**Color Scheme:**
- `.logo-main` ("aswin.db"): `var(--text-secondary)`
  - Dark mode: `#94a3b8` (medium-light slate)
  - Light mode: `#475569` (medium-dark slate)
- `.logo-slash` ("/"): `var(--text-tertiary)`
  - Dark mode: `#64748b` (lighter slate)
  - Light mode: `#64748b` (same gray)
- `.logo-accent` ("music"): `#00A3FF` (constant blue in both themes)

**Sizes:**
- `.site-logo`: 28px (homepage), 24px (mobile)
- `.site-logo-small`: 20px (subpages), 18px (mobile)

**Behavior:**
- Homepage: Non-clickable `<div>` (already at home)
- Subpages: Clickable `<a>` link to homepage with hover effect (70% opacity)

**Advantages over SVG:**
- No loading delays
- Automatically inherits theme colors via CSS variables
- Simpler to maintain
- Better accessibility

## Styling Architecture

### CSS Organization
1. **Base styles** (reset, fonts, colors)
2. **Layout** (container, headers, sections, two-section-layout)
3. **Components** (cards, buttons, controls, separators)
4. **View modes** (image-grid, list-view)
5. **Charts** (containers, controls)
6. **Responsive** (media queries)

### Design Principles
- **Dark theme first** (easier on eyes for music browsing)
- **Compact spacing** (maximize content density)
- **Hover states** (visual feedback on all interactive elements)
- **Mobile-first** (single column on small screens)
- **Minimal animations** (0.3s transitions)
- **Multiple view modes** (4 combinations via 2 independent toggles)
- **Clear active states** (primary color background on active buttons)

### Responsive Breakpoints
```css
@media (max-width: 768px) {
    /* Mobile: Stack columns, smaller text, full-width controls */
    /* Two-section-layout: 2 columns â†’ 1 column */
}
```

## Performance

### Loading
- **Initial load**: ~2-3 seconds (56 MB SQLite download)
- **Cached load**: <500ms (browser caches database)
- **Query time**: <50ms for most queries
- **Chart render**: <100ms

### Optimization Techniques
- Browser caching of SQLite file
- Single database load per page
- Client-side queries (no server round-trips)
- CSS transitions (GPU accelerated)
- No framework overhead

### Bundle Size
- **HTML**: ~2-4 KB per page
- **CSS**: 13 KB (includes both themes, all view modes)
- **JavaScript**: ~30 KB total (app.js + artist.js + release.js + theme.js)
- **Database**: 56 MB (one-time download, cached)
- **External CDN**: sql.js (~500 KB), Chart.js (~200 KB), Lucide icons (~50 KB)

**Total first load**: ~57 MB
**Subsequent loads**: ~35 KB (HTML/CSS/JS only)

## Code Architecture

### Key CSS Classes (Homepage)

**Layout:**
- `.two-section-layout`: Desktop side-by-side grid (2 columns)
- `.main-content`: Section wrapper
- `.section-header`: Title + controls container
- `.controls-group`: Sort + view toggle button group
- `.control-separator`: Visual separator (|) between control groups

**View Modes:**
- `.image-grid`: Square artwork grid layout
- `.image-card`: Individual artwork card with hover effects
- `.image-card-overlay`: Stats overlay on artwork
- `.list-view`: Text-only list container
- `.list-item`: Individual list row
- `.list-item-info`: Name + metadata section
- `.list-item-stats`: Stats section with icons

**Controls:**
- `.sort-controls`: Sort button container
- `.sort-btn`: Individual sort emoji button
- `.sort-btn.active`: Active sort button (primary color)
- `.view-toggle`: View mode toggle button
- `.view-toggle.active`: Active view toggle (primary color background, white text)
- `.control-separator`: Visual separator (|) between control groups
- `.stat-item`: Icon + value pair

### Key JavaScript Functions (app.js)

**Core Functions:**
- `init()`: Initialize app, load database, setup controls
- `loadStats()`: Query and display database statistics
- `loadTopArtists(limit)`: Load and render top artists (checks view.mode and view.showStats)
- `loadTopAlbums(limit)`: Load and render top albums (checks view.mode and view.showStats)
- `setupSortControls()`: Attach event listeners to sort buttons
- `setupSearch()`: Initialize artist search with debounce

**Rendering Functions:**
- `createArtistImageCard(mbid, name, imageUrl, uniqueTracks, totalListens, totalMinutes, showStats)`: Build artist grid card
  - Conditionally renders overlay based on `showStats` parameter
- `createArtistListItem(mbid, name, uniqueTracks, totalListens, totalMinutes, showStats)`: Build artist text list row
  - Shows name only when `showStats = false`, full info when true
- `createAlbumImageCard(releaseMbid, releaseName, releaseYear, releaseType, albumArtUrl, artistName, artistMbid, tracksListened, totalListens, totalMinutes, showStats)`: Build album grid card
  - Conditionally renders overlay based on `showStats` parameter
- `createAlbumListItem(releaseMbid, releaseName, releaseYear, releaseType, artistName, artistMbid, tracksListened, totalListens, totalMinutes, showStats)`: Build album text list row
  - Shows name only when `showStats = false`, full info when true
- `toggleView(section, toggleType)`: Handle view mode switching
  - `section`: 'artists' or 'albums'
  - `toggleType`: 'stats' (eye button) or 'list' (list button)
  - Modifies `viewState[section]` object properties
- `updateViewButtonStates(section)`: Update button active states after rendering
  - Adds/removes `.active` class based on current view state
  - Called automatically after `loadTopArtists()` and `loadTopAlbums()`

**Search Functions:**
- `performSearch(query)`: Execute artist search query, render results

**Utility Functions:**
- `formatNumber(num)`: Add thousand separators
- `escapeHtml(text)`: Sanitize text for safe HTML insertion

### Key JavaScript Functions (year.js)

**Core Functions:**
- `init()`: Initialize app, load database, setup year navigation and controls
- `populateYearSelector()`: Fill dropdown with available years (MAX_YEAR to MIN_YEAR)
- `loadYearStats()`: Query and display year-specific statistics (artists, albums, plays)
- `loadTopArtists(limit)`: Load top artists for selected year (checks view.mode and view.showStats)
- `loadTopAlbums(limit)`: Load top albums for selected year (checks view.mode, view.showStats, and albumFilterMode)
- `setupYearNavigation()`: Initialize year selector, prev/next buttons
- `setupSortControls()`: Attach event listeners to sort buttons
- `setupAlbumFilter()`: Initialize album filter toggle button

**State Management:**
- `currentYear`: Currently selected year (from URL or defaults to MAX_YEAR)
- `albumFilterMode`: 'listens' (default) or 'released'
  - 'listens': Shows albums listened to in that year (WHERE l.year = currentYear)
  - 'released': Shows albums released in that year (WHERE r.release_year = currentYear)
- `sortState`: Track sort preference for artists/albums independently
- `viewState`: Track view mode (grid/list) and showStats for artists/albums

**Rendering Functions:**
- `createArtistImageCard(mbid, name, imageUrl, uniqueTracks, totalListens, totalMinutes, showStats)`: Build artist grid card
- `createArtistListItem(mbid, name, uniqueTracks, totalListens, totalMinutes, showStats)`: Build artist list row
- `createAlbumImageCard(releaseMbid, releaseName, releaseYear, releaseType, albumArtUrl, artistName, artistMbid, tracksListened, totalListens, totalMinutes, showStats)`: Build album grid card
- `createAlbumListItem(releaseMbid, releaseName, releaseYear, releaseType, artistName, artistMbid, tracksListened, totalListens, totalMinutes, showStats)`: Build album list row
- `toggleView(section, toggleType)`: Handle view mode switching (same as app.js)
- `updateViewButtonStates(section)`: Update button active states (same as app.js)

**Navigation Functions:**
- `navigateToYear(year)`: Reload page with new year parameter
- `updateNavigationButtons()`: Enable/disable prev/next arrows at year boundaries

**Utility Functions:**
- `formatNumber(num)`: Add thousand separators
- `escapeHtml(text)`: Sanitize text for safe HTML insertion

### Key JavaScript Functions (artist.js)

**Core Functions:**
- `init()`: Initialize app, load database, get artist ID from URL params
- `loadArtistInfo()`: Query artist metadata including `profile_image_url`, display photo and stats
- `loadTopTracks()`: Load top tracks with listen/minute counts
- `loadReleases()`: Load releases with sorting support
- `loadListeningHistory()`: Load monthly/yearly listening data
- `setupChartControls()`: Initialize chart toggle buttons
- `setupSortControls()`: Initialize sort buttons for tracks/releases

**Chart Functions:**
- `updateChart()`: Render/update Chart.js instance based on chartState
- `createChartData()`: Transform SQL results into Chart.js format

**Image Display:**
- Artist page queries `profile_image_url` from database
- Displays Spotify artist photo in 150x150 container (120x120 on mobile)
- Falls back to SVG music note placeholder if no image available

## Key SQL Queries

### Top Artists by Minutes
```sql
SELECT
    a.artist_mbid,
    a.artist_name,
    COUNT(DISTINCT l.track_mbid) as unique_tracks,
    COUNT(l.timestamp) as total_listens,
    CAST(SUM(COALESCE(t.duration_ms, 0)) / 60000.0 AS INTEGER) as total_minutes
FROM artists a
LEFT JOIN track_artists ta ON a.artist_mbid = ta.artist_mbid AND ta.role = 'main'
LEFT JOIN tracks t ON ta.track_mbid = t.track_mbid
LEFT JOIN listens l ON t.track_mbid = l.track_mbid
GROUP BY a.artist_mbid
HAVING total_listens > 0
ORDER BY total_minutes DESC
LIMIT 20
```

### Artist Listening History (Monthly)
```sql
SELECT
    l.year,
    l.month,
    COUNT(*) as listen_count
FROM listens l
WHERE l.main_artist_mbid = ?
GROUP BY l.year, l.month
ORDER BY l.year, l.month
```

### Release Tracks with Play Counts
```sql
SELECT
    t.track_name,
    t.track_mbid,
    GROUP_CONCAT(DISTINCT a.artist_name, ', ') as artists,
    COUNT(l.timestamp) as play_count
FROM tracks t
LEFT JOIN track_artists ta ON t.track_mbid = ta.track_mbid
LEFT JOIN artists a ON ta.artist_mbid = a.artist_mbid
LEFT JOIN listens l ON t.track_mbid = l.track_mbid
WHERE t.release_mbid = ?
GROUP BY t.track_mbid
ORDER BY play_count DESC, t.track_name
```

## User Experience Features

### Navigation Flow
```
Homepage
  â”œâ”€> Search â†’ Artist Page â†’ Release Page
  â”œâ”€> Top Artists â†’ Artist Page
  â”œâ”€> Top Albums â†’ Release Page
  â””â”€> Year Link (2011-2025) â†’ Year Page

Year Page
  â”œâ”€> Top Artists â†’ Artist Page â†’ Release Page
  â”œâ”€> Top Albums â†’ Release Page
  â”œâ”€> Year Selector / Arrows â†’ Other Year Pages
  â”œâ”€> Logo (aswin.db/music) â†’ Homepage
  â””â”€> "â† Home" Button â†’ Homepage

Artist Page
  â”œâ”€> Top Releases â†’ Release Page
  â”œâ”€> Logo (aswin.db/music) â†’ Homepage
  â””â”€> "â† Back" Button â†’ Previous Page (via history.back())

Release Page
  â”œâ”€> Artist Name Link â†’ Artist Page
  â”œâ”€> Logo (aswin.db/music) â†’ Homepage
  â””â”€> "â† Back" Button â†’ Previous Page (via history.back())
```

**Back Button Behavior:**
- **Year Page**: "â† Home" with direct link to `index.html` (clear destination)
- **Artist/Release Pages**: "â† Back" with `history.back()` (can be reached from multiple places)
- All pages: Logo is clickable on subpages, takes you home

### Page Titles

**Format**: `aswin.db/music - {context}` (or just `aswin.db/music` for homepage)

**Implementation:**
- **index.html**: `aswin.db/music` (static)
- **year.html**: `aswin.db/music - {year}` (e.g., "aswin.db/music - 2015")
- **artist.html**: `aswin.db/music - {artist_name}` (e.g., "aswin.db/music - Kendrick Lamar")
- **release.html**: `aswin.db/music - {release_name}` (e.g., "aswin.db/music - good kid, m.A.A.d city")

**Dynamic Updates:**
- JavaScript updates `document.title` after loading data
- Consistent format across all pages
- Better SEO and bookmarking experience

### Interactive Controls

**Homepage & Year Page Layout:**
- Desktop (â‰¥769px): Side-by-side two-column layout for Artists/Albums
- Mobile (<768px): Stacked single-column layout

**View Toggle Controls:**
- Two independent icon-based buttons (ğŸ‘ï¸ eye, ğŸ“‹ list)
- Visual separator (|) between sort and view controls
- **Clear active states** with primary color background
- Instant re-render on toggle
- State persists per section (artists/albums independent)
- **Eye button behavior**: Toggles stats on/off (works in both grid and list modes)
- **List button behavior**: Toggles between grid and list layout
- Active indicators:
  - Eye active (primary bg) = stats shown
  - List active (primary bg) = list mode
  - Both inactive = grid without stats
  - Both active = list with stats

**Chart Controls:**
- 4-button layout (2 groups of 2)
- Active state highlighting (primary color)
- Instant updates (no loading state)
- Independent state per page

**Sort Controls:**
- Icon-based buttons (ğŸ§ â±ï¸ ğŸ“…)
- Tooltips on hover
- Active state highlighting
- Instant re-query and render

**Theme Toggle:**
- Fixed bottom-right position
- Always accessible
- Persists across pages
- Respects system preference

### Mobile Responsiveness

**Breakpoint**: 768px

**Changes on mobile:**
- Logo scales down (60px â†’ 50px)
- Stats grid: 4 columns â†’ 2 columns
- **Two-section-layout: side-by-side â†’ stacked (3rem gap)**
- Artist header: horizontal â†’ vertical stack
- Artist photo: 150px â†’ 120px
- Chart controls: horizontal â†’ vertical stack, full width
- Two-column sections â†’ single column
- Sort buttons: expand to fill width
- Image grid: tighter spacing (1rem â†’ 0.75rem, 180px â†’ 140px min)

## Data Source Integration

### Parser Project
**Location**: `/Users/aswin/github/lfm-to-parquet/`

**Key Files:**
- `lastfm_importer.py` - Main importer script (1,237 lines, updated with overrides support)
- `config.yaml` - Configuration (includes overrides section)
- `demo_queries.py` - Example SQL queries

**Modes:**
- `import_and_refresh` - Parse JSON, load existing data, add new listens, update metadata/images (default)
- `refresh_only` - Skip JSON parsing, only update metadata (MusicBrainz) and images (Spotify) for existing records
- `full_rebuild` - Start fresh, ignore existing data

**Features:**
- Incremental mode (load existing, add new)
- MusicBrainz integration (release types, dates) - optional
- **Spotify integration** (high-quality images + track durations)
- **Manual overrides support** (applies changes from music_editor)
- **Artist deduplication** (consolidates duplicate entries)
- Track name cleaning ("Original Mix", "Remaster")
- Artist role parsing (featured, collaboration)
- Dual output: Parquet + SQLite

### Music Editor (Private Tool)

**Location**: `/Users/aswin/github/actuallyaswin.github.io/music_editor/`
**Access**: Local only (`http://127.0.0.1:8080/music_editor/`)
**Status**: Not deployed to GitHub Pages

**Purpose**: Manual curation of listening history data. Allows editing artist images, album art, release metadata, track names, and hiding items from public view.

**Architecture**:
- Two-database system: raw data + overrides
- Overrides applied during import process
- Hidden items completely removed from final database

**Features**:
- Browse & search (artists, releases, tracks)
- Edit forms with image URL helpers (Spotify, Last.FM, Apple Music)
- Hide functionality (remove from public browser)
- Edit history tracking with timestamps and notes
- Review overrides dashboard with stats
- Export overrides to JSON backup

**Workflow**:
1. Copy raw database to music_editor/
2. Make manual edits in browser UI
3. Save changes (auto-downloads overrides.sqlite)
4. Re-run importer to apply overrides
5. Deploy merged database to music app

**Integration**: Importer reads overrides database and:
- Updates images, metadata, track names
- Deletes hidden items and associated listens
- Produces final listening_history.sqlite for deployment

See `/music_editor/context.md` for full documentation.

### Spotify Integration

**Purpose:** Fetch high-quality images and track durations

**Features:**
- **Artist photos**: Square images (640x640) for profile display
- **Album art**: Square artwork (640x640) for releases
- **Track durations**: Fetch `duration_ms` for all tracks (much faster than MusicBrainz)

**Authentication:**
- Uses Client Credentials OAuth flow
- No user login required
- Automatic token refresh

**Configuration** (`config.yaml`):
```yaml
spotify:
  enabled: true
  client_id: "952dfbe7669b4ebe8ccb2b9b591be33f"
  client_secret: "dc3bb7aec57f44269914099a0a78c75f"
  cache_file: "/Users/aswin/.spotify_cache.pickle"
```

**How it works:**
1. Parser loads existing data
2. Identifies artists/albums without images
3. Searches Spotify API by name
4. Caches results to minimize API calls
5. Updates `profile_image_url` and `album_art_url` columns

**Benefits:**
- Professional quality images perfect for grids
- Square format (640x640) - no cropping needed
- Better coverage than Last.fm
- Cached results persist across runs

### Artist Deduplication

**Problem:** Same artist appears multiple times with different IDs
- Artist with MusicBrainz ID + artist without ID
- Capitalization differences ("kendrick lamar" vs "Kendrick Lamar")
- Featured/collaboration parsing creates duplicates

**Solution:** Automatic deduplication after metadata fetching

**Algorithm:**
1. Group artists by normalized name (lowercase, trimmed)
2. Choose canonical entry:
   - Priority 1: Real MusicBrainz UUID (36 chars)
   - Priority 2: Entry with profile image
   - Priority 3: First entry
3. Merge metadata (keep best images)
4. Update all references in `track_artists` and `listens` tables
5. Remove duplicates

**Example:**
```
Before deduplication:
- Artist A: "kendrick lamar" (generated-id-abc, no image)
- Artist B: "Kendrick Lamar" (mbid-xyz-123, with image)

After deduplication:
- Artist B: "Kendrick Lamar" (mbid-xyz-123, with image)
  â†’ All track_artists and listens now reference mbid-xyz-123
```

**Impact:** Cleaner artist catalog, consistent imagery, no duplicate entries in UI

### Update Workflow

**Import and Refresh Mode (default):**
```bash
# 1. Update parser data (import new listens, fetch images, deduplicate)
cd /Users/aswin/github/lfm-to-parquet
python3 lastfm_importer.py

# What happens:
# - Loads existing data (incremental mode)
# - Processes new listens from Last.fm JSON export
# - Fetches MusicBrainz metadata (if enabled) for release types/dates
# - Fetches Spotify images for artists/albums without images
# - Fetches Spotify track durations for all tracks
# - Deduplicates artists automatically
# - Saves updated Parquet + SQLite

# 2. Copy database to web folder
cp /Users/aswin/Downloads/lfm_data/listening_history.sqlite \
   /Users/aswin/github/actuallyaswin.github.io/music/

# 3. Deploy to GitHub Pages
cd /Users/aswin/github/actuallyaswin.github.io
git add music/listening_history.sqlite
git commit -m "Update music database with new listens and Spotify images"
git push
```

**Refresh-Only Mode (update images/metadata only):**
```bash
# 1. Set mode in config.yaml
cd /Users/aswin/github/lfm-to-parquet
# Edit config.yaml: mode: "refresh_only"

# 2. Run importer (skips JSON parsing, only updates metadata/images)
python3 lastfm_importer.py

# What happens:
# - Loads existing data from parquet files
# - Skips JSON parsing (no new listens added)
# - Fetches MusicBrainz metadata for records without metadata
# - Fetches Spotify images for artists/albums without images
# - Fetches Spotify track durations for tracks without durations
# - Deduplicates artists automatically
# - Saves updated Parquet + SQLite

# 3. Copy database and deploy (same as above)
```

**Expected output:**
```
Fetching Spotify images...
  Fetching images for 1,234 artists...
  Fetching album art for 2,345 releases...

Deduplicating artists...
  Found 15 artists with duplicates
  Merged 23 duplicate artists
  Total artists after deduplication: 8,457
```

## Design Decisions

### Why Static Site?
- âœ… Free hosting (GitHub Pages)
- âœ… No server costs
- âœ… Fast after initial load
- âœ… No backend maintenance
- âœ… Scales automatically
- âœ… Works offline (after first load)

### Why SQLite WASM?
- âœ… 56 MB is acceptable for modern browsers
- âœ… Instant queries (<50ms)
- âœ… Full SQL capabilities
- âœ… No API calls needed
- âœ… Works offline

### Why Vanilla JavaScript?
- âœ… No build step required
- âœ… Smaller bundle size
- âœ… Easier to maintain
- âœ… No dependency updates
- âœ… Faster initial load

### Why Chart.js?
- âœ… Lightweight (~200 KB)
- âœ… Canvas-based (performant)
- âœ… Highly customizable
- âœ… Good mobile support
- âœ… Active maintenance

## Known Limitations

1. **File size**: 56 MB database (acceptable for personal use)
2. **CORS**: Must use HTTP server for local testing (not file://)
3. **Browser requirement**: Modern browsers only (WebAssembly)
4. **Memory**: Full database loads into browser memory
5. **No server-side search**: Search happens client-side only

## Future Enhancement Ideas

- [x] Year-based browsing (implemented via year.html)
- [ ] Genre/tag filtering
- [ ] Decade-based browsing
- [ ] Listening time heatmaps (hour x day of week)
- [ ] Artist comparison tool
- [ ] Export to CSV/JSON
- [ ] Progressive Web App (offline support)
- [ ] Custom color themes (user-selectable)
- [ ] Playlist builder
- [ ] Advanced search (by genre, tags, etc.)

## Development Notes

### Local Testing
```bash
# Start server from GitHub Pages repo
cd /Users/aswin/github/actuallyaswin.github.io
python3 -m http.server 8080

# Access at: http://127.0.0.1:8080/music/

# Stop server
lsof -ti:8080 | xargs kill
```

**Database Loading:**
- If `music/listening_history.sqlite` exists locally â†’ uses local file (faster for testing)
- If local file missing â†’ automatically falls back to GitHub Releases CDN
- Check browser console to see which source was used

**Testing with local database:**
```bash
# Copy updated database to music folder for local testing
cp /Users/aswin/Downloads/lfm_data/listening_history.sqlite \
   /Users/aswin/github/actuallyaswin.github.io/music/

# Start server and test
python3 -m http.server 8080
# Console will show: "Loading database from local file"

# Remove local database to test CDN fallback
rm /Users/aswin/github/actuallyaswin.github.io/music/listening_history.sqlite
# Console will show: "Loading database from CDN"
```

### Color Refactoring
All colors defined as CSS variables in `:root` and `:root[data-theme="light"]`. No hardcoded colors in:
- HTML files
- JavaScript files (use `getCSSColor('--variable')`)
- CSS (except in variable definitions)

### Accessibility
- Semantic HTML5 elements
- ARIA labels on interactive elements
- Keyboard navigation support
- Color contrast meets WCAG AA
- Focus states on all interactive elements

## Git Information

**Repository**: `https://github.com/actuallyaswin/actuallyaswin.github.io`
**Branch**: main
**Path**: `/music/`

**Deployment**: Automatic via GitHub Pages (1-2 min after push)

## Statistics (Current Data)

- ğŸ“… **14 years** of listening (2011-2025)
- ğŸ§ **124,483 listens**
- ğŸµ **8,480 artists**
- ğŸ’¿ **14,556 releases**
- ğŸ¼ **42,153 unique tracks**
- ğŸ¤ **2,900 featured** + **488 collaboration** credits

**Top track**: "The Happy Song" by Imogen Heap (191 plays)

## Browser Compatibility

**Minimum Requirements:**
- WebAssembly support
- ES6+ JavaScript (arrow functions, template literals, async/await)
- Fetch API
- Canvas API (for charts)
- CSS Grid and Flexbox
- CSS Custom Properties (variables)

**Tested On:**
- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

## Technical Debt / TODOs

None currently. Project is in good shape:
- âœ… All hardcoded colors refactored to CSS variables
- âœ… Theme system fully implemented with soft light mode background
- âœ… Responsive design complete
- âœ… Duration-based sorting implemented
- âœ… Charts optimized (height, labels)
- âœ… Multiple view modes with independent toggles (4 combinations)
- âœ… Clear active states on all toggle buttons
- âœ… Side-by-side desktop layout
- âœ… Name-only list view implemented
- âœ… Spotify integration for high-quality images (640x640 square)
- âœ… Artist deduplication in parser (consolidates duplicates)
- âœ… Artist photos display on artist detail pages
- âœ… Year page with full feature parity (sorting, views, album filter)
- âœ… Plain text logo with CSS theming (replaced SVG)
- âœ… Consistent navigation patterns (back buttons, logo links)
- âœ… Standardized page titles across all pages
- âœ… Code is clean and maintainable
- âœ… Music editor for manual curation (private tool, not deployed)
- âœ… Override system integrated with importer (hidden items support)

## Last Updated
2025-01-11

## Recent Updates (2025-01-11)

### UI Polish & Consistency

**Logo System Redesign:**
- Replaced SVG logo with plain text: `aswin.db/music`
- Uses monospace font stack for consistency
- Theme-aware colors via CSS variables:
  - "aswin.db" â†’ `var(--text-secondary)` (adapts to theme)
  - "/" â†’ `var(--text-tertiary)` (subtle gray)
  - "music" â†’ `#00A3FF` (constant blue accent)
- Clickable on all subpages (takes you home)
- Hover effect on subpages (70% opacity transition)
- No loading delays, simpler maintenance

**Navigation Standardization:**
- **Year page**: "â† Home" button (direct link to index.html)
- **Artist/Release pages**: "â† Back" button (uses history.back())
- Logo clickable on all non-home pages
- Consistent user experience across all pages

**Title Standardization:**
- All pages use format: `aswin.db/music - {context}`
- Homepage: `aswin.db/music` (static)
- Year page: `aswin.db/music - 2015` (dynamic)
- Artist page: `aswin.db/music - Kendrick Lamar` (dynamic)
- Release page: `aswin.db/music - good kid, m.A.A.d city` (dynamic)
- Better SEO and bookmarking experience

**Light Mode Refinement:**
- Changed background from harsh white (`#ffffff`) to soft off-white (`#fafbfc`)
- Updated secondary background to `#f1f3f5` for better contrast hierarchy
- More comfortable on the eyes, similar to GitHub/Notion
- Logo text properly visible in light mode

**Impact:**
- More polished, professional appearance
- Better theme support across light/dark modes
- Consistent navigation patterns throughout the site
- Improved accessibility and user experience

### Year Page Implementation

**Created year.html and year.js:**
- New dedicated page for exploring music by year (2011-2025)
- Accessible from homepage via "2011 â€“ 2025" link
- Complete feature parity with homepage (sorting, view modes, etc.)

**Year Navigation:**
- Hero-style year selector dropdown in header
- Previous/next year arrow buttons
- URL parameter support (`?year=2015`)
- Automatically determines available year range from database
- Summary stats showing artists, albums, and plays for that year

**Top Artists & Top Albums (Year-Specific):**
- Same sorting system as homepage (ğŸ§ listens, â±ï¸ minutes)
- Same view system as homepage (ğŸ‘ï¸ stats toggle, ğŸ“‹ list/grid toggle)
- Shows headphone and clock icons for all entries
- Side-by-side layout on desktop, stacked on mobile
- All 4 view combinations available (grid/list Ã— stats on/off)

**Album Filter Feature (Unique to Year Page):**
- ğŸ” Filter button toggles between two modes:
  - **Default**: Albums listened to in that year (WHERE l.year = currentYear)
  - **Active**: Albums released in that year with all-time listens (WHERE r.release_year = currentYear)
- Useful for discovering albums that came out in a specific year
- Filter button shows active state with primary color background
- Positioned in controls group: `[ğŸ§] [â±ï¸] | [ğŸ”] [ğŸ‘ï¸] [ğŸ“‹]`

**Implementation:**
- Created year.js (~500 lines) with same architecture as app.js
- State management: sortState, viewState, albumFilterMode, currentYear
- Rendering functions match homepage (grid/list, with/without stats)
- Query filters by year: `WHERE l.year = ${currentYear}`

**Impact:**
- Browse listening history year-by-year
- Compare different years' top artists/albums
- Discover albums released in specific years
- Consistent UI/UX across all pages

### Music Editor Implementation

**Created private curation tool** (`/music_editor/`, not deployed):
- Local-only web application for manual data cleanup
- Two-database architecture: raw data + overrides
- Integrated with importer pipeline

**Features** (All 3 phases completed):
- **Browse & Search**: Find artists, releases, tracks with override indicators
- **Edit Forms**: Modify images, metadata, track names with notes
- **Image Helpers**: Fetch from Spotify, Last.FM, or enter custom URLs
- **Hide Functionality**: Mark items to remove from public browser
- **Edit History**: Full audit trail with timestamps and notes
- **Review Dashboard**: Statistics and bulk operations
- **Export**: JSON backup of all overrides

**Integration with Importer**:
- Updated `lastfm_importer.py` (124 lines added)
- Updated `config.yaml` with `overrides` section
- Overrides applied after database creation:
  - Update images, metadata, track names
  - Delete hidden items and associated listens
  - Final database deployed without hidden content

**Workflow**:
1. Edit data in music_editor (local browser)
2. Save creates `listening_history_overrides.sqlite`
3. Re-run importer with overrides enabled
4. Deploy merged database to music app
5. Hidden items never visible in public UI

**Impact:**
- Full control over data quality and presentation
- Clean up artist duplicates, incorrect metadata
- Remove unwanted content from listening history
- Professional presentation with curated images

## Recent Updates (2025-01-10)

### Spotify Track Durations

**Added to lastfm_importer.py:**
- `search_track()` method in SpotifyClient - Searches Spotify for tracks by name + artist
- `fetch_spotify_durations()` method in NormalizedParser - Fetches durations for all tracks
- Integrated into pipeline after image fetching
- **Speed improvement**: Minutes instead of 12+ hours (MusicBrainz rate limit)
- **Coverage**: ~80-90% match rate (Spotify's catalog is extensive)

**Updated config.yaml:**
- Disabled MusicBrainz by default (`enabled: false`)
- Now uses Spotify API for track durations (much faster, no 1 req/sec limit)
- MusicBrainz still available for release types/dates if needed

**Benefits:**
- Track duration data enables "listening time" statistics in web app
- Fast refresh: ~15-20 minutes for 42,153 tracks vs 12 hours with MusicBrainz
- Single API for images + durations (simpler infrastructure)

### Database Hosting via GitHub Releases

**New centralized config:**
- Created `config.js` for single-source database URL management
- Easy version updates: change one line instead of three files
- GitHub Releases + CDN approach prevents 56MB file in repo
- **Smart fallback**: Tries local file first (for testing), falls back to CDN

**Files modified:**
- Created `.gitignore` to exclude database from git
- Added `config.js` with DB_CONFIG object and `fetchDatabase()` method
- Updated `index.html`, `artist.html`, `release.html` to load config.js
- Updated `app.js`, `artist.js`, `release.js` to use `DB_CONFIG.fetchDatabase()`

**Development workflow:**
- Local testing: Copy database to `/music/` folder, automatically used
- Production: Database served from GitHub Releases CDN
- Console logs show which source is being used

## Recent Updates (2025-01-09)

### LastFM Importer Refactoring (Parser Updates)

**Renamed script:**
- `lastfm_parser.py` â†’ `lastfm_importer.py`
- Updated header documentation to reflect new modes

**Added new mode system:**
- `import_and_refresh` - Default mode, processes JSON and updates metadata/images
- `refresh_only` - New mode that skips JSON parsing, only updates metadata (MusicBrainz) and images (Spotify)
- `full_rebuild` - Starts fresh, ignores existing data
- Backward compatible with old `incremental` mode

**Updated workflow:**
- Can now refresh images/metadata without processing JSON export
- Useful for updating Spotify images or MusicBrainz data for existing records
- Skips duplicate listen detection and JSON parsing overhead

### Spotify Integration & Artist Deduplication (Parser Updates)

**Added to lastfm_importer.py:**
- `SpotifyClient` class with OAuth Client Credentials flow
- Automatic token refresh and persistent caching
- `search_artist()` - Fetches 640x640 square artist photos
- `search_album()` - Fetches 640x640 album artwork
- `fetch_spotify_images()` method integrated into pipeline
- Only fetches for entities missing images (efficient)

**Added artist deduplication:**
- `normalize_artist_name()` helper function
- `deduplicate_artists()` method that runs after metadata fetching
- Groups by normalized name, prefers real MBIDs, merges metadata
- Updates all FK references in `track_artists` and `listens` tables
- Consolidates duplicates like "Kendrick Lamar" and "Feed Me"

**Updated config.yaml:**
- Added `spotify` section with client credentials
- Cache file: `/Users/aswin/.spotify_cache.pickle`

**Updated artist.js:**
- Modified `loadArtistInfo()` to query `profile_image_url` from database
- Displays Spotify artist photo in artist header (150x150 container)
- Falls back to SVG placeholder if no image available

**Impact:**
- High-quality square images on homepage artist grid
- Artist photos display on artist detail pages
- Duplicate artists consolidated automatically
- Cleaner, more professional UI

### View System Overhaul (Final Implementation)

**Independent Toggle System:**
- Refactored viewState from single string to object structure: `{ mode: 'grid'|'list', showStats: boolean }`
- Eye button (ğŸ‘ï¸) and List button (ğŸ“‹) now work independently
- Eye button toggles stats on/off in ANY mode (grid or list)
- List button switches between grid and list layout
- Creates 4 distinct view combinations instead of 3 sequential modes

**Clear Active States:**
- Added `.active` class styling with primary color background and white text
- Eye button shows active when stats are enabled (`showStats = true`)
- List button shows active when in list mode (`mode = 'list'`)
- Visual feedback makes current state immediately obvious

**Name-Only List View:**
- List mode with stats OFF now shows just artist/album names
- Perfect for quick scanning without visual clutter
- Requested feature: "turn off stats and turn on list, you should just see a list of names only"

**Function Updates:**
- All rendering functions accept `showStats` parameter
- Added `updateViewButtonStates(section)` to manage active classes
- Simplified toggle logic - direct property manipulation instead of mode cycling

### Earlier Updates (Same Day)

**View System Enhancement:**
- Added three distinct view modes: grid with stats, grid clean (no overlay), and list view (text-only)
- Implemented two toggle buttons: eye icon for stats overlay, list icon for text view
- Added visual separator (|) between sort controls and view toggles

**Layout Improvements:**
- Changed homepage to side-by-side layout on desktop (Top Artists | Top Albums)
- Created `.two-section-layout` CSS Grid wrapper
- Automatically stacks to single column on mobile (â‰¤768px)
- Improved spacing and responsive breakpoints

**List View Features:**
- Text-only rows with artist/album name on left, stats on right
- Shows metadata: artist name, year, release type for albums
- Displays track count for artists
- Maintains Lucide icons for headphones and clock
- Compact, scannable format for quick browsing

## Last Updated
2025-01-11
